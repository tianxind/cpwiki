<p class="subtitle">点击图片添加评论&nbsp;&nbsp;<a onclick="showAllTags()">[显示所有评论]</a></p>
<div id="photo_div">
	<img id="photo" src='<%= "/images/#{@photo.filename}" %>' class="photo_to_tag"></img>
</div>

<div id="dialog" title="添加评论">
		<form>
		<input type="text" name="comment" id="comment" class="text ui-widget-content ui-corner-all" />
		<input type="hidden" id="xpos" />
		<input type="hidden" id="ypos" />
		<input type="hidden" id="photo_id" value='<%= @photo.id %>' />
		</form>
</div>
<script>
$('#dialog').dialog({
	autoOpen: false,
	resizable: false,
	height: 200,
	modal: true,
	buttons: {
	Cancel: function() {
		$(this).dialog( "close" );
	},
	"提交": function() {
		comment = $("#comment").val();
		xpos = $("#xpos").val();
		ypos = $("#ypos").val();
		$.ajax({
			type: "POST",
			url: "/tags",
			dataType: "html",
			data: "comment=" + comment + "&xpos=" + xpos + "&ypos="
				+ ypos + "&photo_id=" + '<%= @photo.id %>',
			success: function(){
				alert("success");
				$('#dialog').dialog("close");
				// Insert tag at correct position
				var newTag = "<div class='tag' style='left:" + xpos + "px;top:" + ypos + "px;'>" 
					+ comment + "</div>";
				// console.log(newTag);
				$("#photo_div").append(newTag);
				$('#comment').val("");
			},
			error: function(){
				alert("Post failed");
				$('#dialog').dialog("close");
			}
		});
	}
	}
});

$('#photo').click(function(e) {
	$('#dialog').dialog("open");
	var photoDiv = $('#photo_div');
	$('#dialog').dialog("option", { position: [e.pageX - $(document).scrollLeft() + 5, e.pageY -$(document).scrollTop() + 5] });
	$('#xpos').val(e.pageX - photoDiv.offset().left);
	$('#ypos').val(e.pageY - photoDiv.offset().top);
});

function showAllTags() {
	<% for tag in @tags %>
		var newTag = "<div class='tag' style='left:" + <%= tag.pos_x %> + "px;top:" + <%= tag.pos_y %>
			+ "px;'>" + '<%= tag.comment %>' + "</div>";
		// console.log(newTag);
		$("#photo_div").append(newTag);
	<% end %>
}
</script>