<% p "current id is >>>>>>>>>>>>" + @cp.id.to_s %>
<!-- <div class="wiki_title">
	<%= @seme.name %>和<%= @uke.name %>的配对	<% if(@already_liked > 0) %><button type="button" id="like">已萌</button><% else %><button type="button" id="like">萌</button><% end %>
</div> -->

<div class="wiki_title">
	<%= @seme.name %>和<%= @uke.name %>的配对 
	<%= @cp.acronym.empty? ? "" : "(#{@cp.acronym})" %>&nbsp;&nbsp;<% if @already_liked == 0 %><a href="javascript:void(0)" id="like_button_a" style="background-color:#CCCCCC;">Moe</a><% else %><a href="javascript:void(0)" id="like_button_a" style="background-color:#FFC0CB;">Moed</a><% end %>
	<span class="edit"><%= link_to '编辑攻', edit_character_path(@seme) %></span>
	<span class="edit"><%= link_to '编辑受', edit_character_path(@uke) %></span>
	<span class="edit"><%= link_to '编辑CP', edit_cp_path(@cp) %></span>
</div>

<div class="wiki_contents">
	<div class="character_basic_info">
		<%= render(:partial => "character_info", :locals => {:character => @seme}) %>
		<%= render(:partial => "character_info", :locals => {:character => @uke}) %>	
	</div>
	<p><%= formatted(@cp.summary) %></p>
	<div class="index">
		<h4 style="text-align: center">目录</h4>
		<ol class="toc">
	    	<li>角色介绍
				<ol>
					<li><%= @seme.name %></li>
					<li><%= @uke.name %></li>
				</ol>
			</li>
			<li>JQ档案</li>
		</ol>
	</div>
	<p class="subtitle">角色介绍</p>
	<p class="subsubtitle"><%= @seme.name %></p>
	<p><%= formatted(@seme.summary) %></p>
	<p class="subsubtitle"><%= formatted(@uke.name) %></p>
	<p><%= formatted(@uke.summary) %></p>
	<p class="subtitle">JQ档案</p>
	<p><%= formatted(@cp.wiki_content) %></p>
</div>

<p class="subtitle">评论</p>
<div id="comments_block">
	<% if @comment_array %>
		<% p "comment_array size is >>>>> " + @comment_array.size.to_s %>
		<% @comment_array.each do |cmt| %>
			<p>&gt;&gt; <%= cmt.comment_text %> - <%= User.find_by_id(cmt.user_id).username %> [<%= cmt.date_time.strftime("%Y-%m-%d %T") %>]</p>
		<% end %>
	<% end %>

	<div id="new_comment"></div>
</div>


<!-- <div class="comment_box">
	<%=  form_tag("/comments", :method => "post") do %>
	  <table>
	    <tr>
	      <td><%= label_tag(:comment_text, "评论:")%></td>
	      <td><%= text_area_tag(:comment_text) %></td>
			</tr>
	  </table>
  <%= submit_tag "提交GO" %>
<% end %>
</div> -->



<p>添加评论：</p>
<textarea rows="4" cols="50" id="comment_area">
</textarea>

<br/><button type="button" id="submit_new_comment">提交</button>

<script>
// add new comment
$(document).ready(function(){
  $("button#submit_new_comment").click(function(){
  	var cmt = $('textarea#comment_area').val();
    //$("#new_comment").text(cmt);

    console.log("start ajax");

    var username = '<%= current_user.username %>';
    var index = <%= params[:id] %>;
    var currentdate = new Date(); 
		var create_time = currentdate.getFullYear() + "-"
                + ("0" + (currentdate.getMonth() + 1)).slice(-2) + "-" 
                + ("0" + currentdate.getDate()).slice(-2) + " "  
                + currentdate.getHours() + ":"  
                + currentdate.getMinutes() + ":" 
                + currentdate.getSeconds();
    console.log("user id in js is " + username);
    console.log("index in js is  " + index);
    console.log("create time is " + create_time);

    $.ajax({
	     type: "POST",
	     url: "/comments",
	     dataType: "html",
	     data: "comment_text=" + cmt + "&id=" + index + "&create_time=" + create_time,
	     success: function(){
	     	 $('#new_comment').append('<p>&gt;&gt; ' + cmt + ' - ' + username + ' [' + create_time + ']' + '</p>');
	     	 //$('#new_comment').append('<div>- ' + cmt + '</div>');
	       	 alert("Data Saved");
	     },
	     error: function(){
	     	 alert("Error post");
	     }
		});

  });

// like/dislike button
  $("a#like_button_a").click(function(){
  //   var index = <%= params[:id] %>;
  //   console.log("index in like button is  " + index);
  //   $.ajax({
	 //     type: "POST",
	 //     url: "/likes",
	 //     dataType: "html",
	 //     data: "cp_id=" + index,
	 //     success: function(){
	 //     	 console.log("already liked " + <%= @already_liked %>)
	 //     	 if(document.getElementById('like').text == "萌") {
	 //     	   $("button#like").css('background-color','#FFC0CB');
	 //     	   //<%= @already_liked = 1 %>
	 //     	   //$("button#like").text = "已萌"
	 //     	   document.getElementById('like').text = "已萌"
	 //     	   alert("Data Saved, like");
	 //     	 } else {
	 //     	 	 $("button#like").css('background-color','#D3D3D3');
	 //     	 	 //<%= @already_liked = 0 %>
	 //     	 	 document.getElementById('like').text = "萌"
	 //     	 	 alert("Data Saved, dislike");
	 //     	 }
	 //       // alert("Data Saved");
	 //     },
	 //     error: function(){
	 //     	 alert("Error post");
	 //     }
		// });
  // });

  // $("a#like_button_a").click(function(){
    var index = <%= params[:id] %>;
    console.log("index in like button is  " + index);
    console.log("post like/dislike to controller");
    console.log($(this).text());
    var like_text = $(this).text();
    $.ajax({
	     type: "POST",
	     url: "/likes",
	     dataType: "html",
	     data: "cp_id=" + index,
	     success: function(){
	     	console.log("in success text is " + like_text);
	     	 //console.log("already liked " + <%= @already_liked %>)
	     	 if(like_text == "Moe") {
	     	   $("a#like_button_a").css('background-color','#FFC0CB');
	     	   //<%= @already_liked = 1 %>
	     	   //$("button#like").text = "已萌"
	     	   console.log("in save like");
	     	   $('a#like_button_a').text('Moed');
	     	   alert("Data Saved, like");
	     	 } else {
	     	 	 $("a#like_button_a").css('background-color','#CCCCCC');
	     	 	 //<%= @already_liked = 0 %>
	     	 	 console.log("in save dislike");
	     	 	 $('a#like_button_a').text('Moe');
	     	 	 alert("Data Saved, dislike");
	     	 }
	     },
	     error: function(){
	     	// Customize error info
	     	alert("Something went wrong.");
	     }
		});
  });

});

	// if(<%= @already_liked %> > 0) {
	// 	$("button#like").css('background-color','#FFC0CB');
	// } else {
	// 	$("button#like").css('background-color','#D3D3D3');
	// }

</script>









